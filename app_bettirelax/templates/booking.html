{% extends 'main.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="container" style="height: 200px;"></div>
<div class="container mt-4">
    <h1><center>El√©rhet≈ës√©g - {{ year }}. {{ month_name }}</center></h1>
    <div class="row">
        <div class="col-md-6 col-12">
            <div class="d-flex justify-content-between mb-3">
                {% if year > today.year or year == today.year and month > today.month %}
                    <a href="?month={{ prev_month }}&year={{ prev_year }}" class="btn btn-outline-primary">&larr; El≈ëz≈ë h√≥nap</a>
                {% else %}
                &nbsp &nbsp
                {% endif %}
                <a href="?month={{ next_month }}&year={{ next_year }}" class="btn btn-outline-primary">K√∂vetkez≈ë h√≥nap &rarr;</a>
            </div>
        
            <!-- Foglal√°si napt√°r -->
            <table class="table table-bordered text-center table-calendar">
                <thead>
                    <tr>
                        {% for day in days_of_week %}
                            <th>{{ day }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for week in calendar_data %}
                    <tr>
                        {% for day in week %}
                        <td class="calendar-cell {% if day.status == 'green' %}bg-success text-white{% elif day.status == 'red' %}bg-danger text-white{% elif day.status == 'grey' %}bg-secondary text-white{% else %}bg-light{% endif %}"
                            data-date="{{ day.date|date:'Y-m-d' }}"
                            onclick="toggleSelection(this)">
                            {% if day.status != 'empty' %}
                                <div>
                                    {{ day.date.day }}
                                </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Id≈ëpont kiv√°laszt√°s -->
        <div class="col-md-6 col-12 d-none" id="slot-selection">
            <label for="available-slots">V√°lassz id≈ëpontot:</label>
            <select id="available-slots" class="form-control">
                <option value="" disabled selected>Nincs kiv√°lasztott id≈ëpont</option>
            </select><br>
                <h4>El√©rhet≈ë szolg√°ltat√°sok:</h4>
                <div id="service-list"></div>
        </div>
    </div>
    <div class="text-center mt-3">
        <button id="booking-details-btn" class="btn btn-primary mt-2 d-none">Foglal√°si adatok megad√°sa</button>
    </div>
</div>
<div class="container" style="height: 200px;"></div>

<script>
let selectedDate = null;
let selectedTime = null;
let selectedService = null;
let selectedServiceDuration = null; 

function toggleSelection(cell) {
    const date = cell.getAttribute("data-date");
    if (!date || cell.classList.contains("bg-danger") || cell.classList.contains("bg-secondary")) return;

    // Ha volt el≈ëz≈ë kiv√°lasztott, √°ll√≠tsuk vissza z√∂ldre
    if (selectedDate) {
        const prevSelected = document.querySelector(".selected-date");
        if (prevSelected) {
            prevSelected.classList.remove("selected-date");
            prevSelected.classList.add("bg-success");

            // ‚è≥ El≈ëz≈ë szolg√°ltat√°sok t√∂rl√©se
            document.getElementById("service-list").innerHTML = "";
            document.getElementById("booking-details-btn").classList.add("d-none"); // Gomb elrejt√©se
            selectedService = null;
        }
    }

    // √öj kijel√∂lt elem kezel√©se
    cell.classList.remove("bg-success");
    cell.classList.add("selected-date");

    selectedDate = date;
    fetchAvailableSlots(date);
}

function fetchAvailableSlots(date) {
    fetch(`/api/available_slots/?date=${date}`)
        .then(response => response.json())
        .then(data => {
            if (data.available_slots) {  // ‚úÖ Ha van available_slots kulcs, akkor folytatja!
                updateDropdown(data.available_slots);
            } else {
                console.error("HIBA: Nincsenek el√©rhet≈ë id≈ëpontok a JSON v√°laszban!", data);
            }
        })
        .catch(error => console.error("Hiba:", error));
}

function updateDropdown(slots) {
    let dropdown = document.getElementById("available-slots");
    let slotSection = document.getElementById("slot-selection");

    dropdown.innerHTML = "";

    if (slots.length > 0) {
        // üü¢ Els≈ë opci√≥: Csak kezdetben l√°tsz√≥dik
        let defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "V√°lassz id≈ëpontot";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        defaultOption.hidden = true; // üî• Nem jelenik meg a leg√∂rd√ºl≈ë list√°ban
        dropdown.appendChild(defaultOption);

        // üìå Id≈ëpontok hozz√°ad√°sa
        slots.forEach(slot => {
            let option = document.createElement("option");
            option.value = slot;
            option.textContent = slot;
            dropdown.appendChild(option);
        });

        slotSection.classList.remove("d-none");
    } else {
        // ‚ùå Ha nincs el√©rhet≈ë id≈ëpont
        dropdown.innerHTML = '<option value="" disabled selected>Nincs el√©rhet≈ë id≈ëpont</option>';
        slotSection.classList.remove("d-none");
    }
}

document.getElementById("available-slots").addEventListener("change", function() {
    selectedTime = this.value;
    if (!selectedDate || !selectedTime) return;

    fetchAvailableServices(selectedDate, selectedTime);
});

function fetchAvailableServices(date, time) {
    fetch(`/api/available_services/?date=${date}&time=${time}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateServiceList(data.available_services);
            }
        })
        .catch(error => console.error("Hiba:", error));
}


function updateServiceList(services) {
    let serviceList = document.getElementById("service-list");
    serviceList.innerHTML = ""; // T√∂r√∂lj√ºk az el≈ëz≈ë szolg√°ltat√°sokat

    if (services.length > 0) {
        services.forEach(service => {
            let serviceElement = document.createElement("div");
            serviceElement.classList.add("service-item", "p-2", "border", "rounded", "mb-2", "text-center");
            // üî• JavaScript ezres elv√°laszt√≥ form√°z√°s √©s tizedesjegyek elhagy√°sa
            // üî• Biztos√≠tjuk, hogy az √°r eg√©sz sz√°m legyen
            let price = Math.round(Number(service.price)); 
            let formattedPrice = price.toLocaleString("hu-HU");
            serviceElement.textContent = `${service.service_name} (${service.duration} perc - ${formattedPrice} Ft)`;
            serviceElement.setAttribute("data-service-id", service.service_id);
            serviceElement.setAttribute("data-service-duration", service.duration); 

            serviceElement.addEventListener("click", function () {
                selectService(this);
            });

            serviceList.appendChild(serviceElement);
        });
    } else {
        serviceList.innerHTML = "<p>Nincs el√©rhet≈ë szolg√°ltat√°s.</p>";
    }
}

function selectService(serviceElement) {
    let serviceId = serviceElement.getAttribute("data-service-id");

    console.log("Service selected:", serviceId);

    // Elt√°vol√≠tjuk az el≈ëz≈ë kijel√∂l√©st
    document.querySelectorAll(".service-item").forEach(el => el.classList.remove("selected-service"));

    // √öj kijel√∂l√©s
    serviceElement.classList.add("selected-service");
    selectedService = serviceId;
    selectedServiceDuration = serviceElement.getAttribute("data-service-duration");

    // Enged√©lyezz√ºk a tov√°bb gombot
    document.getElementById("booking-details-btn").classList.remove("d-none");
}

document.getElementById("booking-details-btn").addEventListener("click", function() {
    console.log("Selected service:", selectedService);
    console.log("Selected service duration:", selectedServiceDuration);
    console.log("Selected date:", selectedDate);
    console.log("Selected time:", selectedTime);

    if (!selectedService || !selectedDate || !selectedTime || !selectedServiceDuration) {
        alert("K√©rlek v√°lassz egy d√°tumot, id≈ëpontot √©s szolg√°ltat√°st!");
        return;
    }

    const queryParams = new URLSearchParams({
        date: selectedDate,
        time: selectedTime,
        service_id: selectedService,
        duration: selectedServiceDuration,
    });

    window.location.href = `/booking/details/?${queryParams.toString()}`;
});
</script>


{% endblock %}
